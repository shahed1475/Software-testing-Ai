name: Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - regression
          - api
          - mobile
      browser:
        description: 'Browser to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit
      environment:
        description: 'Environment to test against'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  test:
    timeout-minutes: 60
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        browser: [chromium, firefox, webkit]
        exclude:
          # WebKit is not supported on Windows
          - os: windows-latest
            browser: webkit
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps ${{ matrix.browser }}

    - name: Create reports directory
      run: mkdir -p reports

    - name: Run Playwright tests
      env:
        CI: true
        BROWSER: ${{ matrix.browser }}
        TEST_ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
        BASE_URL: ${{ secrets.BASE_URL }}
        API_BASE_URL: ${{ secrets.API_BASE_URL }}
        TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
        TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
        ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      run: |
        if [ "${{ github.event.inputs.test_suite }}" = "smoke" ]; then
          npm run test:smoke -- --project=${{ matrix.browser }}
        elif [ "${{ github.event.inputs.test_suite }}" = "regression" ]; then
          npm run test:regression -- --project=${{ matrix.browser }}
        elif [ "${{ github.event.inputs.test_suite }}" = "api" ]; then
          npm run test:api -- --project=${{ matrix.browser }}
        elif [ "${{ github.event.inputs.test_suite }}" = "mobile" ]; then
          npm run test:mobile -- --project=${{ matrix.browser }}
        else
          npm run test -- --project=${{ matrix.browser }}
        fi
      shell: bash

    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.os }}-${{ matrix.browser }}
        path: |
          reports/
          test-results/
        retention-days: 30

    - name: Upload Allure Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-results-${{ matrix.os }}-${{ matrix.browser }}
        path: allure-results/
        retention-days: 30

  # Generate and deploy Allure report
  allure-report:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all Allure results
      uses: actions/download-artifact@v4
      with:
        pattern: allure-results-*
        path: allure-results
        merge-multiple: true

    - name: Get Allure history
      uses: actions/checkout@v4
      if: always()
      continue-on-error: true
      with:
        ref: gh-pages
        path: gh-pages

    - name: Setup Allure
      uses: simple-elf/allure-report-action@master
      if: always()
      with:
        allure_results: allure-results
        allure_history: allure-history
        keep_reports: 20

    - name: Deploy Allure report to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: allure-history

  # Smoke tests for quick feedback
  smoke-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: Run smoke tests
      env:
        CI: true
        BROWSER: chromium
        TEST_ENVIRONMENT: staging
        BASE_URL: ${{ secrets.BASE_URL }}
        TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
        TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      run: npm run test:smoke

    - name: Upload smoke test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results
        path: |
          reports/
          test-results/
        retention-days: 7

  # Performance tests
  performance-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.test_suite == 'performance'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: Run performance tests
      env:
        CI: true
        BROWSER: chromium
        PERFORMANCE_TESTING_ENABLED: true
        PERFORMANCE_THRESHOLD_MS: 3000
        BASE_URL: ${{ secrets.BASE_URL }}
      run: npm run test:performance

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results
        path: |
          reports/
          test-results/
        retention-days: 30

  # Security tests
  security-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.test_suite == 'security'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: Run security tests
      env:
        CI: true
        BROWSER: chromium
        SECURITY_TESTING_ENABLED: true
        BASE_URL: ${{ secrets.BASE_URL }}
        ZAP_API_KEY: ${{ secrets.ZAP_API_KEY }}
      run: npm run test:security

    - name: Upload security results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-test-results
        path: |
          reports/
          test-results/
        retention-days: 30

  # Notification job
  notify:
    runs-on: ubuntu-latest
    needs: [test, smoke-tests]
    if: always()
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Send notifications
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
        EMAIL_TO: ${{ secrets.EMAIL_TO }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_RUN_ID: ${{ github.run_id }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_REF: ${{ github.ref }}
        GITHUB_ACTOR: ${{ github.actor }}
        TEST_RESULTS: ${{ needs.test.result }}
        SMOKE_RESULTS: ${{ needs.smoke-tests.result }}
      run: |
        node -e "
        const { execSync } = require('child_process');
        const testResult = process.env.TEST_RESULTS || 'unknown';
        const smokeResult = process.env.SMOKE_RESULTS || 'unknown';
        const runUrl = \`https://github.com/\${process.env.GITHUB_REPOSITORY}/actions/runs/\${process.env.GITHUB_RUN_ID}\`;
        const allureUrl = \`https://\${process.env.GITHUB_REPOSITORY.split('/')[0]}.github.io/\${process.env.GITHUB_REPOSITORY.split('/')[1]}\`;
        
        const message = \`
        ðŸŽ­ Playwright Test Results
        
        ðŸ“Š **Test Status**: \${testResult === 'success' ? 'âœ… Passed' : 'âŒ Failed'}
        ðŸš€ **Smoke Tests**: \${smokeResult === 'success' ? 'âœ… Passed' : smokeResult === 'skipped' ? 'â­ï¸ Skipped' : 'âŒ Failed'}
        
        ðŸ“‹ **Details**:
        â€¢ Repository: \${process.env.GITHUB_REPOSITORY}
        â€¢ Branch: \${process.env.GITHUB_REF.replace('refs/heads/', '')}
        â€¢ Commit: \${process.env.GITHUB_SHA.substring(0, 7)}
        â€¢ Actor: \${process.env.GITHUB_ACTOR}
        
        ðŸ”— **Links**:
        â€¢ [View Run](\${runUrl})
        â€¢ [Allure Report](\${allureUrl})
        \`;
        
        if (process.env.SLACK_WEBHOOK_URL) {
          const payload = {
            text: 'Playwright Test Results',
            blocks: [
              {
                type: 'section',
                text: {
                  type: 'mrkdwn',
                  text: message
                }
              }
            ]
          };
          
          try {
            execSync(\`curl -X POST -H 'Content-type: application/json' --data '\${JSON.stringify(payload)}' \${process.env.SLACK_WEBHOOK_URL}\`);
            console.log('Slack notification sent successfully');
          } catch (error) {
            console.error('Failed to send Slack notification:', error.message);
          }
        }
        "

  # Clean up old artifacts
  cleanup:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
    - name: Delete old artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const oldArtifacts = artifacts.data.artifacts.filter(artifact => {
            const createdAt = new Date(artifact.created_at);
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            return createdAt < thirtyDaysAgo;
          });
          
          for (const artifact of oldArtifacts) {
            await github.rest.actions.deleteArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifact.id,
            });
            console.log(`Deleted artifact: ${artifact.name}`);
          }