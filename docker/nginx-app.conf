server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html index.htm;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # CORS headers for testing
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";
        add_header Access-Control-Max-Age 1728000;
        add_header Content-Type "text/plain; charset=utf-8";
        add_header Content-Length 0;
        return 204;
    }

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json
        image/svg+xml;

    # Main application routes
    location / {
        try_files $uri $uri/ /index.html;
        
        # Cache static assets
        location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # API mock endpoints for testing
    location /api/ {
        # Mock API responses
        location = /api/health {
            default_type application/json;
            return 200 '{"status": "ok", "timestamp": "$time_iso8601"}';
        }
        
        location = /api/users {
            default_type application/json;
            return 200 '{"users": [{"id": 1, "name": "John Doe", "email": "john@example.com"}, {"id": 2, "name": "Jane Smith", "email": "jane@example.com"}]}';
        }
        
        location = /api/products {
            default_type application/json;
            return 200 '{"products": [{"id": 1, "name": "Product 1", "price": 99.99}, {"id": 2, "name": "Product 2", "price": 149.99}]}';
        }
        
        location ~ ^/api/users/([0-9]+)$ {
            default_type application/json;
            return 200 '{"id": $1, "name": "User $1", "email": "user$1@example.com"}';
        }
        
        location ~ ^/api/products/([0-9]+)$ {
            default_type application/json;
            return 200 '{"id": $1, "name": "Product $1", "price": 99.99}';
        }
        
        # Default API response
        default_type application/json;
        return 404 '{"error": "API endpoint not found"}';
    }

    # Authentication mock endpoints
    location /auth/ {
        location = /auth/login {
            default_type application/json;
            return 200 '{"token": "mock-jwt-token", "user": {"id": 1, "name": "Test User", "email": "test@example.com"}}';
        }
        
        location = /auth/logout {
            default_type application/json;
            return 200 '{"message": "Logged out successfully"}';
        }
        
        location = /auth/profile {
            default_type application/json;
            return 200 '{"id": 1, "name": "Test User", "email": "test@example.com", "role": "user"}';
        }
    }

    # Search endpoint for testing
    location /search {
        default_type application/json;
        return 200 '{"results": [{"id": 1, "title": "Search Result 1", "description": "Description 1"}, {"id": 2, "title": "Search Result 2", "description": "Description 2"}], "total": 2}';
    }

    # Form submission endpoints
    location /contact {
        if ($request_method = POST) {
            return 200 '{"message": "Contact form submitted successfully"}';
        }
        try_files $uri $uri/ /contact.html;
    }

    location /newsletter {
        if ($request_method = POST) {
            return 200 '{"message": "Newsletter subscription successful"}';
        }
        return 405 '{"error": "Method not allowed"}';
    }

    # Simulate slow responses for performance testing
    location /slow {
        default_type application/json;
        # Add 2 second delay
        echo_sleep 2;
        return 200 '{"message": "Slow response", "delay": "2s"}';
    }

    # Simulate error responses for error handling testing
    location /error/500 {
        return 500 '{"error": "Internal server error"}';
    }
    
    location /error/404 {
        return 404 '{"error": "Not found"}';
    }
    
    location /error/403 {
        return 403 '{"error": "Forbidden"}';
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Error pages
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    # Logging
    access_log /var/log/nginx/app_access.log;
    error_log /var/log/nginx/app_error.log;
}